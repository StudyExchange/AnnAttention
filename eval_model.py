import argparse
import random
import time
import numpy as np
import torch
import warnings
from transformers import AutoTokenizer, AutoModelForCausalLM
from model.model import MiniMindLM
from model.LMConfig import LMConfig
from model.model_lora import *

warnings.filterwarnings('ignore')


def init_model(args):
    tokenizer = AutoTokenizer.from_pretrained('./model/minimind_tokenizer')
    if args.load == 0:
        moe_path = '_moe' if args.use_moe else ''
        modes = {0: 'pretrain', 1: 'full_sft', 2: 'rlhf', 3: 'reason'}
        ckp = f'./{args.out_dir}/{modes[args.model_mode]}_{args.dim}{moe_path}.pth'
        print(f'eval model load: {ckp}')

        model = MiniMindLM(LMConfig(
            dim=args.dim,
            n_layers=args.n_layers,
            max_seq_len=args.max_seq_len,
            use_moe=args.use_moe
        ))

        state_dict = torch.load(ckp, map_location=args.device)
        model.load_state_dict({k: v for k, v in state_dict.items() if 'mask' not in k}, strict=True)

        if args.lora_name != 'None':
            apply_lora(model)
            load_lora(model, f'./{args.out_dir}/lora/{args.lora_name}_{args.dim}.pth')
    else:
        model = AutoModelForCausalLM.from_pretrained(
            './MiniMind2',
            trust_remote_code=True
        )
    print(f'MiniMindæ¨¡å‹å‚æ•°é‡: {sum(p.numel() for p in model.parameters() if p.requires_grad) / 1e6:.2f}M(illion)')
    return model.eval().to(args.device), tokenizer


def get_prompt_datas(args):
    if args.model_mode == 0:
        # pretrainæ¨¡å‹çš„æ¥é¾™èƒ½åŠ›ï¼ˆæ— æ³•å¯¹è¯ï¼‰
        prompt_datas = [
            'é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†',
            'äººç±»å¤§è„‘çš„ä¸»è¦åŠŸèƒ½',
            'ä¸‡æœ‰å¼•åŠ›åŸç†æ˜¯',
            'äºŒæ°§åŒ–ç¢³åœ¨ç©ºæ°”ä¸­',
            'æ­å·å¸‚çš„ç¾é£Ÿæœ‰',
            'é™ˆè¿°ï¼š\nåœ¨è¿‡å»çš„å‡ åå¹´é‡Œï¼Œå…¨çƒæ°”å€™å˜åŒ–é—®é¢˜æ—¥ç›Šä¸¥é‡ï¼Œç§‘å­¦å®¶ä»¬é€šè¿‡å„ç§ç ”ç©¶å’Œæ•°æ®åˆ†æï¼Œæ­ç¤ºäº†äººç±»æ´»åŠ¨å¯¹åœ°çƒæ°”å€™ç³»ç»Ÿçš„æ·±è¿œå½±å“ã€‚å·¥ä¸šåŒ–è¿›ç¨‹ä¸­çš„å¤§é‡æ¸©å®¤æ°”ä½“æ’æ”¾ï¼Œå°¤å…¶æ˜¯äºŒæ°§åŒ–ç¢³å’Œç”²çƒ·ï¼Œå¯¼è‡´äº†å…¨çƒæ°”æ¸©çš„æ˜¾è‘—ä¸Šå‡ã€‚è¿™ç§æ°”æ¸©ä¸Šå‡ä¸ä»…å¼•å‘äº†æç«¯å¤©æ°”äº‹ä»¶çš„é¢‘ç¹å‘ç”Ÿï¼Œå¦‚çƒ­æµªã€æš´é›¨ã€å¹²æ—±å’Œé£“é£ï¼Œè¿˜å¯¹ç”Ÿæ€ç³»ç»Ÿã€å†œä¸šã€æ°´èµ„æºå’Œäººç±»å¥åº·äº§ç”Ÿäº†å¹¿æ³›çš„å½±å“ã€‚æåœ°å†°ç›–çš„èåŒ–å¯¼è‡´æµ·å¹³é¢ä¸Šå‡ï¼Œå¨èƒç€æ²¿æµ·åŸå¸‚å’Œå²›å±¿å›½å®¶çš„ç”Ÿå­˜ã€‚æ­¤å¤–ï¼Œæ°”å€™å˜åŒ–è¿˜åŠ å‰§äº†ç¤¾ä¼šä¸å¹³ç­‰ï¼Œå› ä¸ºè´«å›°å›½å®¶å’Œç¤¾åŒºå¾€å¾€ç¼ºä¹åº”å¯¹æ°”å€™ç¾å®³çš„èµ„æºã€‚å›½é™…ç¤¾ä¼šå·²ç»æ„è¯†åˆ°è¿™ä¸€é—®é¢˜çš„ç´§è¿«æ€§ï¼Œå¹¶é€šè¿‡ã€Šå·´é»åå®šã€‹ç­‰å…¨çƒæ€§åè®®è¯•å›¾å‡ç¼“æ°”å€™å˜åŒ–çš„å½±å“ã€‚ç„¶è€Œï¼Œå°½ç®¡å„å›½æ‰¿è¯ºå‡å°‘ç¢³æ’æ”¾ï¼Œå®é™…æ‰§è¡ŒåŠ›åº¦ä»ç„¶ä¸è¶³ï¼Œå…¨çƒæ°”æ¸©ä¸Šå‡çš„è¶‹åŠ¿å°šæœªå¾—åˆ°æœ‰æ•ˆéåˆ¶ã€‚ä¸æ­¤åŒæ—¶ï¼Œç§‘å­¦å®¶ä»¬ä¹Ÿåœ¨ç§¯ææ¢ç´¢åº”å¯¹æ°”å€™å˜åŒ–çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆï¼Œå¦‚ç¢³æ•è·æŠ€æœ¯ã€å¯å†ç”Ÿèƒ½æºçš„å¹¿æ³›åº”ç”¨ä»¥åŠç”Ÿæ€æ¢å¤é¡¹ç›®ã€‚å…¬ä¼—æ„è¯†çš„æé«˜å’Œä¸ªä½“è¡Œä¸ºçš„æ”¹å˜ä¹Ÿè¢«è§†ä¸ºåº”å¯¹æ°”å€™å˜åŒ–çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ç„¶è€Œï¼Œé¢å¯¹è¿™ä¸€å…¨çƒæ€§æŒ‘æˆ˜ï¼Œå›½é™…åˆä½œã€æ”¿ç­–æ‰§è¡Œå’ŒæŠ€æœ¯åˆ›æ–°çš„ç»“åˆä»ç„¶æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ã€‚\n\né—®é¢˜ï¼š\n\nå…¨çƒæ°”å€™å˜åŒ–å¯¹äººç±»å’Œåœ°çƒç”Ÿæ€ç³»ç»Ÿçš„å½±å“æœ‰å“ªäº›å…·ä½“è¡¨ç°ï¼Ÿå›½é™…ç¤¾ä¼šåœ¨åº”å¯¹æ°”å€™å˜åŒ–æ–¹é¢é‡‡å–äº†å“ªäº›æªæ–½ï¼Ÿè¿™äº›æªæ–½çš„æ•ˆæœå¦‚ä½•ï¼Ÿæœªæ¥åº”å¯¹æ°”å€™å˜åŒ–çš„æŒ‘æˆ˜å’Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ\n\nç­”æ¡ˆï¼š',
            '<s>é‰´åˆ«ä¸€ç»„ä¸­æ–‡æ–‡ç« çš„é£æ ¼å’Œç‰¹ç‚¹ï¼Œä¾‹å¦‚å®˜æ–¹ã€å£è¯­ã€æ–‡è¨€ç­‰ã€‚éœ€è¦æä¾›æ ·ä¾‹æ–‡ç« æ‰èƒ½å‡†ç¡®é‰´åˆ«ä¸åŒçš„é£æ ¼å’Œç‰¹ç‚¹ã€‚</s> <s>å¥½çš„ï¼Œç°åœ¨å¸®æˆ‘æŸ¥ä¸€ä¸‹ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·?ä»Šå¤©çš„å¤©æ°”ä¾æ®åœ°åŒºè€Œå¼‚ã€‚è¯·é—®ä½ éœ€è¦æˆ‘å¸®ä½ æŸ¥è¯¢å“ªä¸ªåœ°åŒºçš„å¤©æ°”å‘¢ï¼Ÿ</s> <s>æ‰“å¼€é—¹é’ŸåŠŸèƒ½ï¼Œå®šä¸€ä¸ªæ˜å¤©æ—©ä¸Šä¸ƒç‚¹çš„é—¹é’Ÿã€‚å¥½çš„ï¼Œæˆ‘å·²ç»å¸®æ‚¨æ‰“å¼€é—¹é’ŸåŠŸèƒ½ï¼Œé—¹é’Ÿå°†åœ¨æ˜å¤©æ—©ä¸Šä¸ƒç‚¹å‡†æ—¶å“èµ·ã€‚</s> <s>ä¸ºä»¥ä¸‹åœºæ™¯å†™ä¸€å¥è¯æè¿°ï¼šä¸€ä¸ªå­¤ç‹¬çš„è€äººååœ¨å…¬å›­é•¿æ¤…ä¸Šçœ‹ç€è¿œå¤„ã€‚ä¸€ä½å­¤ç‹¬çš„è€äººååœ¨å…¬å›­é•¿æ¤…ä¸Šå‡è§†è¿œæ–¹ã€‚</s> <s>éå¸¸æ„Ÿè°¢ä½ çš„å›ç­”ã€‚è¯·å‘Šè¯‰æˆ‘ï¼Œè¿™äº›æ•°æ®æ˜¯å…³äº',
            '<s>æœ€å¥½æ˜¯ä¸€äº›æ—¥å¸¸ç”¨è¯­å’Œå·¥ä½œç›¸å…³çš„å•è¯ã€‚å¥½çš„ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä¸€äº›ç›¸å…³å•è¯å’ŒçŸ­è¯­çš„åˆ—è¡¨ã€‚æ‚¨æƒ³è¦æˆ‘ç«‹å³å‘é€å—ï¼Ÿ</s> <s>ä½ å¥½ï¼Œèƒ½å‘Šè¯‰æˆ‘ä¸–ç•Œæ¯çš„å† å†›æ˜¯è°å—ï¼Ÿä½ å¥½ï¼å½“ç„¶å¯ä»¥ï¼Œæœ€è¿‘ä¸€å±Šä¸–ç•Œæ¯çš„å† å†›æ˜¯æ³•å›½ã€‚è¿˜æœ‰ä»€ä¹ˆæˆ‘èƒ½å¸®åŠ©ä½ çš„å—ï¼Ÿ</s> <s>ä¸ºä»¥ä¸‹è¿™ä¸ªåå­—æä¾›ä¸‰ä¸ªç›¸åº”çš„åŒä¹‰è¯ã€‚\nåå­—: éŸ¦æ©ç›¸åº”çš„åŒä¹‰è¯ï¼šéŸ¦æ©å¯ä»¥è¢«æ›¿æ¢ä¸ºéŸ¦å°”çº³ï¼ŒéŸ¦æ©ç‰¹ï¼Œç»´æ©ã€‚</s> <s>æ¥ä¸‹æ¥ï¼Œè¯·ä½ æ‰¾åˆ°è¿™æ®µæ–‡æœ¬ä¸­å‡ºç°æ¬¡æ•°æœ€å°‘çš„å•è¯ã€‚ç¤ºä¾‹æ–‡æœ¬ä¸­å‡ºç°æ¬¡æ•°æœ€å°‘çš„å•è¯æ˜¯"æ£€æµ‹"ï¼Œå®ƒåªå‡ºç°äº†ä¸€æ¬¡ã€‚</s> <s>å¬èµ·æ¥å¾ˆä¸é”™ï¼Œæˆ‘ä¼šå»çœ‹çœ‹è¿™éƒ¨ç”µå½±çš„',
            '<s>ä¸‹æ–‡ä¸­å­˜åœ¨å“ªäº›å®ä½“ï¼š\nå®‰å¾½æ–‡åŒ–éŸ³åƒå‡ºç‰ˆç¤¾è‡ª1995å¹´ä»¥æ¥ï¼Œåˆä½œå‡ºç‰ˆå¼•è¿›æ–‡è‰ºèŠ‚ç›®24ä¸ªã€‚å®‰å¾½æ–‡åŒ–éŸ³åƒå‡ºç‰ˆç¤¾</s> <s>ä¸‹æ–‡ä¸­å­˜åœ¨å“ªäº›å®ä½“ï¼š\nå› æ­¤ï¼Œä¼ä¸šåœ¨æé«˜äº§å“è´¨é‡çš„åŒæ—¶ï¼Œä¹Ÿåº”åˆ‡å®é‡‡å–æªæ–½ï¼Œæé«˜äº§å“è¯´æ˜ä¹¦çš„è´¨é‡ã€‚ä¸å­˜åœ¨å®ä½“</s> <s>å®ä½“æŠ½å–ï¼š\nä»–è¿˜ç»™ä¿„å…±é¢†å¯¼äººä¹…åŠ è¯ºå¤«æ‰“äº†ç”µè¯ï¼Œå¸Œæœ›ä¿„å…±â€œå¤šè€ƒè™‘å›½å®¶åˆ©ç›Šï¼Œå°‘è€ƒè™‘å…šæ´¾åˆ©ç›Šâ€ã€‚ä¹…åŠ è¯ºå¤«,ä¿„å…±</s> <s>å®ä½“æŠ½å–ï¼š\nåŒ»é™¢é™¤æ‹›æ”¶ä¸€æ‰¹è‘—åè€ä¸“å®¶å¤–ï¼Œè¿˜å¸æ”¶äº†è¿‘å¹´å­¦æˆå›å›½çš„ä¸€äº›åŒ»è¯å­¦åšå£«ã€ç¡•å£«ç­‰ä¸“ä¸šäººå‘˜ã€‚ç»„ç»‡ï¼šåŒ»é™¢</s> <s>æŠ½å–å‡ºä¸‹æ–‡ä¸­çš„å®ä½“ï¼š\næˆ‘å¤©',
            '<s>è¯·æå–ä»¥ä¸‹æ–‡æœ¬ä¸­çš„äººç‰©å’Œç»„ç»‡åç§°ï¼šå¼ ä¸‰å’Œæå››åœ¨ç™¾åº¦å’Œè…¾è®¯å·¥ä½œã€‚\näººç‰©åç§°ï¼šå¼ ä¸‰ã€æå››\nç»„ç»‡åç§°ï¼šç™¾åº¦ã€è…¾è®¯</s> <s>å°†è¿™ä¸ªå¥å­æ”¹å†™æˆç®€æ´çš„ç‰ˆæœ¬ã€‚\næˆ‘æƒ³è¦ä»Šå¤©æ™šä¸Šåƒä¸­é¤ï¼Œå› ä¸ºæˆ‘å·²ç»åƒæƒ¯äº†è¥¿é¤äº†ã€‚æˆ‘ä»Šæ™šæƒ³åƒä¸­é¤ï¼Œåƒè¥¿é¤åƒè…»äº†ã€‚</s> <s>é‡å†™ä»¥ä¸‹å¥å­ï¼Œä½¿å…¶æ›´å…·æœ‰è¯´æœåŠ›ã€‚\næ²»ç–—å¤´ç—›çš„è¿™ç§è¯ç‰©è¢«è¯æ˜æ˜¯æœ‰æ•ˆçš„ã€‚ç ”ç©¶è¯å®ï¼Œè¿™ç§è¯ç‰©å¯ä»¥æœ‰æ•ˆåœ°ç¼“è§£å¤´ç—›ã€‚</s> <s>å¯¹äºç»™å®šçš„æ–‡æœ¬ç‰‡æ®µï¼Œé‡æ–°ç¼–å†™ä»¥æ›´åŠ ç®€ç»ƒåœ°è¡¨ç¤ºæ„æ€ã€‚\næ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ­£åœ¨è€ƒè™‘ä¸€ä¸ªä¾‹å­ã€‚ç°åœ¨ï¼Œæˆ‘åœ¨è€ƒè™‘ä¸€ä¸ªä¾‹å­ã€‚</s> <s>æ ¹æ®ä»¥ä¸‹è¾“å…¥ï¼Œç”Ÿæˆ',
            '<s>è¯·æå–ä»¥ä¸‹æ–‡æœ¬ä¸­çš„äººç‰©å’Œç»„ç»‡åç§°ï¼šå¼ ä¸‰å’Œæå››åœ¨ç™¾åº¦å’Œè…¾è®¯å·¥ä½œã€‚\näººç‰©åç§°ï¼šå¼ ä¸‰ã€æå››\nç»„ç»‡åç§°ï¼šç™¾åº¦ã€è…¾è®¯</s> <s>å°†è¿™ä¸ªå¥å­æ”¹å†™æˆç®€æ´çš„ç‰ˆæœ¬ã€‚\næˆ‘æƒ³è¦ä»Šå¤©æ™šä¸Šåƒä¸­é¤ï¼Œå› ä¸ºæˆ‘å·²ç»åƒæƒ¯äº†è¥¿é¤äº†ã€‚æˆ‘ä»Šæ™šæƒ³åƒä¸­é¤ï¼Œåƒè¥¿é¤åƒè…»äº†ã€‚</s> <s>é‡å†™ä»¥ä¸‹å¥å­ï¼Œä½¿å…¶æ›´å…·æœ‰è¯´æœåŠ›ã€‚\næ²»ç–—å¤´ç—›çš„è¿™ç§è¯ç‰©è¢«è¯æ˜æ˜¯æœ‰æ•ˆçš„ã€‚ç ”ç©¶è¯å®ï¼Œè¿™ç§è¯ç‰©å¯ä»¥æœ‰æ•ˆåœ°ç¼“è§£å¤´ç—›ã€‚</s> <s>å¯¹äºç»™å®šçš„æ–‡æœ¬ç‰‡æ®µï¼Œé‡æ–°ç¼–å†™ä»¥æ›´åŠ ç®€ç»ƒåœ°è¡¨ç¤ºæ„æ€ã€‚\næ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ­£åœ¨è€ƒè™‘ä¸€ä¸ªä¾‹å­ã€‚ç°åœ¨ï¼Œæˆ‘åœ¨è€ƒè™‘ä¸€ä¸ªä¾‹å­ã€‚</s> <s>æ ¹æ®ä»¥ä¸‹è¾“å…¥ï¼Œç”Ÿæˆç›¸åº”çš„è¯­å¥ï¼Œä¸”è¿™äº›è¯­å¥åº”ä¸è¾“å…¥æ„æ€ç›¸åã€‚\nè¿™ä¸ªç”µå½±éå¸¸æœ‰è¶£ã€‚è¿™ä¸ªç”µå½±æ²¡æœ‰ä¸€ç‚¹å¥½ç¬‘çš„åœ°æ–¹ã€‚</s> <s>ä»ä»¥ä¸‹æ–‡æœ¬ä¸­æå–é‡‘é¢\næˆ‘åœ¨å•†åº—é‡ŒèŠ±äº†50ç¾å…ƒä¹°äº†ä¸€ä»¶è¡¬è¡«ã€‚ä»ä¸Šé¢çš„æ–‡æœ¬ä¸­ï¼Œé‡‘é¢ä¸º50ç¾å…ƒï¼Œå¯ä»¥è¢«æå–å‡ºæ¥ã€‚</s> <s>ç”¨æ‚¨è‡ªå·±çš„è¯­è¨€é‡æ–°è¡¨è¿°ä»¥ä¸‹å¥å­ã€‚\næœºå™¨ç¿»è¯‘å¯ä»¥å¸®åŠ©äººä»¬è·¨è¶Šè¯­è¨€éšœç¢ã€‚æœºå™¨ç¿»è¯‘æŠ€æœ¯å¯ä»¥ååŠ©äººä»¬å…‹æœè¯­è¨€éšœç¢ã€‚</s> <s>å°†ä»¥ä¸‹å¥å­ç²¾ç®€æˆ5ä¸ªå•è¯çš„ç‰ˆæœ¬ã€‚\nå¦‚æœæˆ‘',
            'åœ°çƒä¸Šæœ€å¤§çš„åŠ¨ç‰©æœ‰',
            'ä¸–ç•Œä¸Šæœ€é«˜çš„å±±å³°æ˜¯',
            'ä½ æ˜¯ä¸€ä¸ªå°è¯´å†™æ‰‹ï¼Œä½ ç°åœ¨éœ€è¦å†™ä¸€ä¸ª400å­—å·¦å³çš„ç«¥è¯æ•…äº‹æ¦‚è¦ã€‚æ•…äº‹æ¦‚è¦ä¸ºï¼š',
            'ä½ æ˜¯ä¸€ä¸ªpythonä¸“å®¶ï¼Œä½ å…ˆéœ€è¦å†™ä¸€ä¸ªæœ€å°å­åºåˆ—å’Œçš„é¢è¯•é¢˜ï¼Œç»™å‡ºæµ‹è¯•æ•°æ®ä»¥åŠå°è£…ä¸ºå‡½æ•°çš„æœ€å°å­åºåˆ—å’Œå®ç°ã€‚ä»£ç å®ç°ä¸ºï¼š',
        ]
    else:
        if args.lora_name == 'None':
            # é€šç”¨å¯¹è¯é—®é¢˜
            prompt_datas = [
                'è¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±ã€‚',
                'ä½ æ›´æ“…é•¿å“ªä¸€ä¸ªå­¦ç§‘ï¼Ÿ',
                'é²è¿…çš„ã€Šç‹‚äººæ—¥è®°ã€‹æ˜¯å¦‚ä½•æ‰¹åˆ¤å°å»ºç¤¼æ•™çš„ï¼Ÿ',
                'æˆ‘å’³å—½å·²ç»æŒç»­äº†ä¸¤å‘¨ï¼Œéœ€è¦å»åŒ»é™¢æ£€æŸ¥å—ï¼Ÿ',
                'è¯¦ç»†çš„ä»‹ç»å…‰é€Ÿçš„ç‰©ç†æ¦‚å¿µã€‚',
                'æ¨èä¸€äº›æ­å·çš„ç‰¹è‰²ç¾é£Ÿå§ã€‚',
                'è¯·ä¸ºæˆ‘è®²è§£â€œå¤§è¯­è¨€æ¨¡å‹â€è¿™ä¸ªæ¦‚å¿µã€‚',
                'å¦‚ä½•ç†è§£ChatGPTï¼Ÿ',
                'Introduce the history of the United States, please.',
                'åœ°çƒä¸Šæœ€å¤§çš„åŠ¨ç‰©æœ‰',
                'ä¸–ç•Œä¸Šæœ€é«˜çš„å±±å³°æ˜¯',
                'ä½ æ˜¯ä¸€ä¸ªå°è¯´å†™æ‰‹ï¼Œä½ ç°åœ¨éœ€è¦å†™ä¸€ä¸ª400å­—å·¦å³çš„ç«¥è¯æ•…äº‹æ¦‚è¦ã€‚æ•…äº‹æ¦‚è¦ä¸ºï¼š',
                'ä½ æ˜¯ä¸€ä¸ªpythonä¸“å®¶ï¼Œä½ å…ˆéœ€è¦å†™ä¸€ä¸ªæœ€å°å­åºåˆ—å’Œçš„é¢è¯•é¢˜ï¼Œç»™å‡ºæµ‹è¯•æ•°æ®ä»¥åŠå°è£…ä¸ºå‡½æ•°çš„æœ€å°å­åºåˆ—å’Œå®ç°ã€‚ä»£ç å®ç°ä¸ºï¼š',
            ]
        else:
            # ç‰¹å®šé¢†åŸŸé—®é¢˜
            lora_prompt_datas = {
                'lora_identity': [
                    "ä½ æ˜¯ChatGPTå§ã€‚",
                    "ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ",
                    "ä½ å’Œopenaiæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"
                ],
                'lora_medical': [
                    'æˆ‘æœ€è¿‘ç»å¸¸æ„Ÿåˆ°å¤´æ™•ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ',
                    'æˆ‘å’³å—½å·²ç»æŒç»­äº†ä¸¤å‘¨ï¼Œéœ€è¦å»åŒ»é™¢æ£€æŸ¥å—ï¼Ÿ',
                    'æœç”¨æŠ—ç”Ÿç´ æ—¶éœ€è¦æ³¨æ„å“ªäº›äº‹é¡¹ï¼Ÿ',
                    'ä½“æ£€æŠ¥å‘Šä¸­æ˜¾ç¤ºèƒ†å›ºé†‡åé«˜ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ',
                    'å­•å¦‡åœ¨é¥®é£Ÿä¸Šéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ',
                    'è€å¹´äººå¦‚ä½•é¢„é˜²éª¨è´¨ç–æ¾ï¼Ÿ',
                    'æˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿåˆ°ç„¦è™‘ï¼Œåº”è¯¥æ€ä¹ˆç¼“è§£ï¼Ÿ',
                    'å¦‚æœæœ‰äººçªç„¶æ™•å€’ï¼Œåº”è¯¥å¦‚ä½•æ€¥æ•‘ï¼Ÿ'
                ],
            }
            prompt_datas = lora_prompt_datas[args.lora_name]

    return prompt_datas


# è®¾ç½®å¯å¤ç°çš„éšæœºç§å­
def setup_seed(seed):
    random.seed(seed)
    np.random.seed(seed)
    torch.manual_seed(seed)
    torch.cuda.manual_seed(seed)
    torch.cuda.manual_seed_all(seed)
    torch.backends.cudnn.deterministic = True
    torch.backends.cudnn.benchmark = False


def get_args():
    parser = argparse.ArgumentParser(description="Chat with MiniMind")
    parser.add_argument('--lora_name', default='None', type=str)
    parser.add_argument('--out_dir', default='out', type=str)
    parser.add_argument('--temperature', default=0.85, type=float)
    parser.add_argument('--top_p', default=0.85, type=float)
    parser.add_argument('--device', default='cuda' if torch.cuda.is_available() else 'cpu', type=str)
    # æ­¤å¤„max_seq_lenï¼ˆæœ€å¤§å…è®¸è¾“å…¥é•¿åº¦ï¼‰å¹¶ä¸æ„å‘³æ¨¡å‹å…·æœ‰å¯¹åº”çš„é•¿æ–‡æœ¬çš„æ€§èƒ½ï¼Œä»…é˜²æ­¢QAå‡ºç°è¢«æˆªæ–­çš„é—®é¢˜
    # MiniMind2-moe (145M)ï¼š(dim=640, n_layers=8, use_moe=True)
    # MiniMind2-Small (26M)ï¼š(dim=512, n_layers=8)
    # MiniMind2 (104M)ï¼š(dim=768, n_layers=16)
    parser.add_argument('--dim', default=512, type=int)
    parser.add_argument('--n_layers', default=8, type=int)
    parser.add_argument('--max_seq_len', default=512, type=int)
    parser.add_argument('--use_moe', default=False, type=bool)
    # æºå¸¦å†å²å¯¹è¯ä¸Šä¸‹æ–‡æ¡æ•°
    # history_cntéœ€è¦è®¾ä¸ºå¶æ•°ï¼Œå³ã€ç”¨æˆ·é—®é¢˜, æ¨¡å‹å›ç­”ã€‘ä¸º1ç»„ï¼›è®¾ç½®ä¸º0æ—¶ï¼Œå³å½“å‰queryä¸æºå¸¦å†å²ä¸Šæ–‡
    # æ¨¡å‹æœªç»è¿‡å¤–æ¨å¾®è°ƒæ—¶ï¼Œåœ¨æ›´é•¿çš„ä¸Šä¸‹æ–‡çš„chat_templateæ—¶éš¾å…å‡ºç°æ€§èƒ½çš„æ˜æ˜¾é€€åŒ–ï¼Œå› æ­¤éœ€è¦æ³¨æ„æ­¤å¤„è®¾ç½®
    parser.add_argument('--history_cnt', default=0, type=int)
    parser.add_argument('--stream', default=True, type=bool)
    parser.add_argument('--load', default=0, type=int, help="0: åŸç”Ÿtorchæƒé‡ï¼Œ1: transformersåŠ è½½")
    parser.add_argument('--model_mode', default=0, type=int,
                        help="0: é¢„è®­ç»ƒæ¨¡å‹ï¼Œ1: SFT-Chatæ¨¡å‹ï¼Œ2: RLHF-Chatæ¨¡å‹ï¼Œ3: Reasonæ¨¡å‹")
    parser.add_argument('--test_mode', default=0, type=int, help="[0] è‡ªåŠ¨æµ‹è¯•, [1] æ‰‹åŠ¨è¾“å…¥")
    # args = parser.parse_args()
    args, unknown = parser.parse_known_args()
    if unknown:
        print(f'eval_model args unknow: {unknown}')
    return args


def main(args):
    print(f'args: {args}')
    model, tokenizer = init_model(args)

    prompts = get_prompt_datas(args)
    # test_mode = int(input('[0] è‡ªåŠ¨æµ‹è¯•\n[1] æ‰‹åŠ¨è¾“å…¥\n'))
    test_mode = args.test_mode
    messages = []
    for idx, prompt in enumerate(prompts if test_mode == 0 else iter(lambda: input('ğŸ‘¶: '), '')):
        setup_seed(random.randint(0, 2048))
        # setup_seed(2025)  # å¦‚éœ€å›ºå®šæ¯æ¬¡è¾“å‡ºåˆ™æ¢æˆã€å›ºå®šã€‘çš„éšæœºç§å­
        if test_mode == 0: print(f'ğŸ‘¶: {prompt}')

        messages = messages[-args.history_cnt:] if args.history_cnt else []
        messages.append({"role": "user", "content": prompt})

        new_prompt = tokenizer.apply_chat_template(
            messages,
            tokenize=False,
            add_generation_prompt=True
        )[-args.max_seq_len + 1:] if args.model_mode != 0 else (tokenizer.bos_token + prompt)

        answer = new_prompt
        with torch.no_grad():
            x = torch.tensor(tokenizer(new_prompt)['input_ids'], device=args.device).unsqueeze(0)
            outputs = model.generate(
                x,
                eos_token_id=tokenizer.eos_token_id,
                max_new_tokens=args.max_seq_len,
                temperature=args.temperature,
                top_p=args.top_p,
                stream=True,
                pad_token_id=tokenizer.pad_token_id
            )

            print('ğŸ¤–ï¸: ', end='')
            try:
                if not args.stream:
                    print(tokenizer.decode(outputs.squeeze()[x.shape[1]:].tolist(), skip_special_tokens=True), end='')
                else:
                    history_idx = 0
                    for y in outputs:
                        answer = tokenizer.decode(y[0].tolist(), skip_special_tokens=True)
                        if (answer and answer[-1] == 'ï¿½') or not answer:
                            continue
                        print(answer[history_idx:], end='', flush=True)
                        history_idx = len(answer)
            except StopIteration:
                print("No answer")
            print('\n')

        messages.append({"role": "assistant", "content": answer})

    del model, tokenizer

if __name__ == "__main__":
    args = get_args()
    main(args)
